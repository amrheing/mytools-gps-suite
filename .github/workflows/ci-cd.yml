name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [published]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
    
    - name: Install Python dependencies
      run: |
        cd extract-gpx-parts/web
        pip install -r requirements.txt
        pip install pytest coverage
    
    - name: Run Python tests
      run: |
        cd extract-gpx-parts/web
        python -m pytest --cov=. --cov-report=xml
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./extract-gpx-parts/web/coverage.xml
        flags: python
        name: codecov-python
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Test JavaScript components
      run: |
        cd google-gpx-converter
        npm install --global @web/test-runner
        # Add JS tests when available

  build:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Google GPX Converter
      run: |
        cd google-gpx-converter
        docker build -t google-gpx-converter:test .
    
    - name: Build Extract GPX Parts
      run: |
        cd extract-gpx-parts
        docker build -t extract-gpx-parts:test .
    
    - name: Test Docker containers
      run: |
        docker compose -f docker-compose.yml config
        docker compose -f docker-compose.yml up -d --build
        sleep 30
        
        # Test Google GPX Converter
        curl -f http://localhost:6010 || exit 1
        
        # Test Extract GPX Parts
        curl -f http://localhost:6020 || exit 1
        
        docker compose down
    
    - name: Run security scan
      uses: aquasec/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
    
    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  deploy:
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: |
          your-dockerhub-username/google-gpx-converter
          your-dockerhub-username/extract-gpx-parts
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha
          type=raw,value=latest,enable={{is_default_branch}}
    
    - name: Build and push Google GPX Converter
      uses: docker/build-push-action@v5
      with:
        context: ./google-gpx-converter
        push: true
        tags: your-dockerhub-username/google-gpx-converter:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Build and push Extract GPX Parts
      uses: docker/build-push-action@v5
      with:
        context: ./extract-gpx-parts
        push: true
        tags: your-dockerhub-username/extract-gpx-parts:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

  release:
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    needs: [test, build]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Create deployment package
      run: |
        tar -czf mytools-gps-suite-${{ github.event.release.tag_name }}.tar.gz \
          --exclude='.git' \
          --exclude='extract-gpx-parts/data/uploads/*' \
          --exclude='extract-gpx-parts/data/processed/*' \
          --exclude='__pycache__' \
          --exclude='*.pyc' \
          .
    
    - name: Upload release asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./mytools-gps-suite-${{ github.event.release.tag_name }}.tar.gz
        asset_name: mytools-gps-suite-${{ github.event.release.tag_name }}.tar.gz
        asset_content_type: application/gzip